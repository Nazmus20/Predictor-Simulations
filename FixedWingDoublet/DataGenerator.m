%   Fixed-Wing Aircraft Simulation in Wind
%   Invariant EKF implementation on MTD3 model
%   Zakia Ahmed
%   2023
clc; clear all; close all;

global e1 e2 e3 m rho g Inertia b c S ...
    Cj2 Cj Cj0 ...
    Cxalpha Cxde Cx0 Cxq Cxalpha2...
    Czalpha Czq Cz0 Czde...
    Cmalpha Cmq Cmde Cm0 ...
    Cybeta Cyp Cyr Cyda Cydr Cy0 ...
    Clbeta Clp Clda Clr Cldr Cl0...
    Cnbeta Cnr Cnda Cndr Cnp Cn0... 
    drpsEq PropDia nProp etaProp VEq deEq thetaEq 
    
% Basis vectors
e1=[1;0;0;];
e2=[0;1;0;];
e3=[0;0;1;];

% Gravity and density
g=9.81; % m/s^2
rho= 1.237; % kg/m^3

% Aircraft physical parameters
m= 3.311; % kg
c= 0.254; % m
b= 1.80; % m
S=0.457; % m^2
Ixx=0.319; % kg-m^2^2
Iyy=0.267; % kg-m^2^2
Izz=0.471; % kg-m^2^2
Ixz=0.024; % kg-m^2^2
Ixy=0;
Iyz=0;
Inertia=[Ixx -Ixy -Ixz; -Ixy Iyy -Iyz; -Ixz -Iyz Izz;];
PropDia= 0.254; % m
nProp=2; % number of props
etaProp= 0.90; % Prop efficiency

%% Parameter estimates

%Longitudinal parameter estimates 
Cj2= -0.13096; Cj= -0.04005; Cj0= 0.115918; 

Cxalpha2 = +3.173 + 0.119; Cxalpha= 0.282; Cxde= 0.051; Cx0= 0.009-0.4374;
Cxq = 0;

Czalpha= -4.436-0.015; Czq= -12.540; Cz0= -0.255; Czde = 0;

Cmq = -14.019; Cmalpha=-0.444-0.027; Cmq=-14.019; Cmde=-0.415; Cm0=0.008;    

%laterial-directional parameter estimates
Cy0 = 0; Cybeta=-0.410; Cyp=0.221; Cyr=0.230; Cyda=0.118; Cydr=0.136;

Cl0 = 0; Clbeta=-0.035-0.004; Clp= -0.386; Clda=-0.137; Clr = 0; Cldr = 0;

Cn0 = 0; Cnp =0 ; Cnbeta=0.083+0.02; Cnr=-0.119; Cnda=0.013; Cndr=-0.068;


%% Determining equilbrium

%Finding an Equilbrium condition for wings level flight, start with initial
%values
VEq=50; % Equilibrium forward speed, m/s
thetaEq=-1*pi/180; %Equilibrium pitch angle, rad
deEq=0; %Elevator deflection at equilibrium, rad 
drpsEq=220; %Propeller rotation per second at equilibrium, rps

EqSol=fsolve('Equilibrium',[VEq;thetaEq;deEq]);
VEq=EqSol(1)
thetaEq=EqSol(2)
deEq=EqSol(3)

%Initial Conditions
s0=[0;0;-100;]; %Position, m
Theta0=[0*pi/180;thetaEq*pi/180;0*pi/180]; % Attitude, rad
v0=[VEq*cos(thetaEq);0;VEq*sin(thetaEq)]; %Body axis velocity, m/s
omega0=[0;0;0];  % Body angular velocity, rad/s
IC=[s0;Theta0;v0;omega0]; %Initial condition vector for ODE45

%% Linearization around the equilibrium, obtained from "EOMs.nb" Needed for KP/SP
%Linearization of 9-states delta_X = [phi;theta;psi;u;v;w;p;q;r]; and
%delta_U = [da; de; dr]
A =[0, 0, 0, 0, 0, 0, 1, 0, .0210031;
    0, 0, 0, 0, 0, 0, 0, 1, 0;
    0, 0, 0, 0, 0, 0, 0, 0, 1.00022;
    0, -9.80784, 0, -1.47158, 0, .620938, 0, -.381349, 0;
    9.80784, 0, 0, 0, -.635785, 0, .689782, 0, -17.8358;
    0, -.205995, 0, -.935573, 0, -6.92332, 0, 15.6872, 0;
    0, 0, 0, 0, -.98159, 0, -10.1034, 0, -.158714;
    0, 0, 0, .0480782, 0, -2.30003, 0, -8.69619, 0;
    0, 0, 0, 0, 1.97102, 0, -.514821, 0, -2.10958];

B = [0,	0,	0; 0, 0, 0; 0, 0, 0; 0, 1.43626, 0; 3.3231, 0, 3.83002;
    0, 0, 0; -72.0089, 0, -1.83008; 0, -36.8122, 0; .963259, 0, -24.3248];

C = eye(9); %Output matrix with 9-states
Cfull = eye(12); %Output matrix with 12 states
D = [];

sysCT = ss(A, B, C, D);

%% Needed for EKP
ff = @(x,u) [x(9)*(sin(x(4))*sin(x(6)) + cos(x(4))*cos(x(6))*sin(x(5))) - 1.0*x(8)*(cos(x(4))*sin(x(6)) - 1.0*cos(x(6))*sin(x(4))*sin(x(5))) + x(7)*cos(x(5))*cos(x(6));
    x(8)*(cos(x(4))*cos(x(6)) + sin(x(4))*sin(x(5))*sin(x(6))) - 1.0*x(9)*(cos(x(6))*sin(x(4)) - 1.0*cos(x(4))*sin(x(5))*sin(x(6))) + x(7)*cos(x(5))*sin(x(6));
    x(9)*cos(x(4))*cos(x(5)) - 1.0*x(7)*sin(x(5)) + x(8)*cos(x(5))*sin(x(4));
    x(10) + x(12)*cos(x(4))*tan(x(5)) + x(11)*sin(x(4))*tan(x(5));
    x(11)*cos(x(4)) - 1.0*x(12)*sin(x(4));
    (x(12)*cos(x(4)) + x(11)*sin(x(4)))/cos(x(5));
    0.30202*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2)*(0.282*atan(x(9)/x(7)) + 0.051*u(2) + 3.292*atan(x(9)/x(7))^2 - 0.4284) - 9.81*sin(x(5)) - 0.097098*(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + x(8)*x(12) - 1.0*x(9)*x(11) - 0.0056818*x(7)^2 - 0.0056818*x(8)^2 - 0.0056818*x(9)^2 + 15.704;
    9.81*cos(x(5))*sin(x(4)) - 1.0*x(7)*x(12) + x(9)*x(10) + 0.30202*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2)*(0.118*u(1) + 0.136*u(3) - 0.41*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) + (0.1989*x(10))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + (0.207*x(12))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2));
    9.81*cos(x(4))*cos(x(5)) - 0.30202*(4.451*atan(x(9)/x(7)) + (1.5926*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + 0.255)*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2) + x(7)*x(11) - 1.0*x(8)*x(10);
    0.84021*x(11)*x(12) - 0.042813*x(10)*x(11) - 3.1469*(0.2466*u(1) + 0.0702*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) + (0.62532*x(10))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2))*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2) + 0.00016035*x(11)*(319.0*x(10) - 24.0*x(12)) + 3.1469*x(11)*(0.024*x(10) - 0.471*x(12)) + 0.16035*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2)*(0.0234*u(1) - 0.1224*u(3) + 0.1854*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) - (0.19278*x(12))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2));
    - 0.011236*x(10)*(8.0*x(10) - 157.0*x(12)) - 0.0037453*x(12)*(319.0*x(10) - 24.0*x(12)) - 3.7453*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2)*(0.11963*atan(x(9)/x(7)) + 0.10541*u(2) + (0.45222*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) - 0.002032);
    0.042813*x(11)*x(12) - 0.56906*x(10)*x(11) + 0.00048105*x(11)*(8.0*x(10) - 157.0*x(12)) - 0.16035*(0.2466*u(1) + 0.0702*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) + (0.62532*x(10))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2))*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2) + 2.1313*x(11)*(0.319*x(10) - 0.024*x(12)) + 2.1313*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2)*(0.0234*u(1) - 0.1224*u(3) + 0.1854*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) - (0.19278*x(12))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2));];
 
 
FF = @(x,u) [0, 0, 0,       1.0*x(8)*(sin(x(4))*sin(x(6)) + 1.0*cos(x(4))*cos(x(6))*sin(x(5))) + x(9)*(cos(x(4))*sin(x(6)) - 1.0*cos(x(6))*sin(x(4))*sin(x(5))), cos(x(6))*(x(9)*cos(x(4))*cos(x(5)) - 1.0*x(7)*sin(x(5)) + x(8)*cos(x(5))*sin(x(4))), x(9)*(cos(x(6))*sin(x(4)) - 1.0*cos(x(4))*sin(x(5))*sin(x(6))) - 1.0*x(8)*(cos(x(4))*cos(x(6)) + 1.0*sin(x(4))*sin(x(5))*sin(x(6))) - 1.0*x(7)*cos(x(5))*sin(x(6)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          cos(x(5))*cos(x(6)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      cos(x(6))*sin(x(4))*sin(x(5)) - 1.0*cos(x(4))*sin(x(6)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          sin(x(4))*sin(x(6)) + cos(x(4))*cos(x(6))*sin(x(5)),                                                                                                             0,                                                                                                  0,                                                                                                                0;
            0, 0, 0, - 1.0*x(8)*(cos(x(6))*sin(x(4)) - 1.0*cos(x(4))*sin(x(5))*sin(x(6))) - 1.0*x(9)*(cos(x(4))*cos(x(6)) + 1.0*sin(x(4))*sin(x(5))*sin(x(6))), sin(x(6))*(x(9)*cos(x(4))*cos(x(5)) - 1.0*x(7)*sin(x(5)) + x(8)*cos(x(5))*sin(x(4))), 1.0*x(9)*(sin(x(4))*sin(x(6)) + 1.0*cos(x(4))*cos(x(6))*sin(x(5))) - 1.0*x(8)*(cos(x(4))*sin(x(6)) - 1.0*cos(x(6))*sin(x(4))*sin(x(5))) + x(7)*cos(x(5))*cos(x(6)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          cos(x(5))*sin(x(6)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          cos(x(4))*cos(x(6)) + sin(x(4))*sin(x(5))*sin(x(6)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      cos(x(4))*sin(x(5))*sin(x(6)) - 1.0*cos(x(6))*sin(x(4)),                                                                                                             0,                                                                                                  0,                                                                                                                0;
            0, 0, 0,                                                                                           cos(x(5))*(x(8)*cos(x(4)) - 1.0*x(9)*sin(x(4))),   - 1.0*x(7)*cos(x(5)) - 1.0*x(9)*cos(x(4))*sin(x(5)) - 1.0*x(8)*sin(x(4))*sin(x(5)),                                                                                                                                                                  0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               -1.0*sin(x(5)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          cos(x(5))*sin(x(4)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          cos(x(4))*cos(x(5)),                                                                                                             0,                                                                                                  0,                                                                                                                0;
            0, 0, 0,                                                                             (sin(x(5))*(x(11)*cos(x(4)) - 1.0*x(12)*sin(x(4))))/cos(x(5)),                                      (x(12)*cos(x(4)) + x(11)*sin(x(4)))/cos(x(5))^2,                                                                                                                                                                  0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                           1.0,                                                                                sin(x(4))*tan(x(5)),                                                                                              cos(x(4))*tan(x(5));
            0, 0, 0,                                                                                               - 1.0*x(12)*cos(x(4)) - 1.0*x(11)*sin(x(4)),                                                                                    0,                                                                                                                                                                  0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                             0,                                                                                          cos(x(4)),                                                                                                   -1.0*sin(x(4));
            0, 0, 0,                                                                                         (x(11)*cos(x(4)) - 1.0*x(12)*sin(x(4)))/cos(x(5)),                          (sin(x(5))*(x(12)*cos(x(4)) + x(11)*sin(x(4))))/cos(x(5))^2,                                                                                                                                                                  0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0,                                                                                                             0,                                                                                sin(x(4))/cos(x(5)),                                                                                              cos(x(4))/cos(x(5));
            0, 0, 0,                                                                                                                                         0,                                                                      -9.81*cos(x(5)),                                                                                                                                                                  0,                                                                                                                                                                                                                                                                                                                                                                                                                        0.17077*x(7)*(0.282*atan(x(9)/x(7)) + 0.051*u(2) + 3.292*atan(x(9)/x(7))^2 - 0.4284) - (0.097098*x(7))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) - 0.011364*x(7) - (1.0e+63*x(9)*(4.3921e+33*atan(x(9)/x(7)) + 1.8812e+32)*(x(7)^2 + x(8)^2 + x(9)^2))/(7.8125e+96*x(7)^2 + 7.8125e+96*x(9)^2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              x(12) - 0.084523*x(8) - (0.097098*x(8))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + 0.56219*atan(x(9)/x(7))^2*x(8) + 0.0087095*u(2)*x(8) + 0.048158*atan(x(9)/x(7))*x(8),                                                                                                                                                                                                                                                                                                                                                                                                            0.17077*x(9)*(0.282*atan(x(9)/x(7)) + 0.051*u(2) + 3.292*atan(x(9)/x(7))^2 - 0.4284) - 1.0*x(11) - (0.097098*x(9))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) - 0.011364*x(9) + (1.0e+63*x(7)*(4.3921e+33*atan(x(9)/x(7)) + 1.8812e+32)*(x(7)^2 + x(8)^2 + x(9)^2))/(7.8125e+96*x(7)^2 + 7.8125e+96*x(9)^2),                                                                                                             0,                                                                                          -1.0*x(9),                                                                                                             x(8);
            0, 0, 0,                                                                                                                  9.81*cos(x(4))*cos(x(5)),                                                            -9.81*sin(x(4))*sin(x(5)),                                                                                                                                                                  0,                                                                                                                                                                                                                                  0.17077*x(7)*(0.118*u(1) + 0.136*u(3) - 0.41*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) + (0.1989*x(10))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + (0.207*x(12))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) - 1.0*x(12) - (0.30202*(0.1989*x(7)*x(10)*(x(7)^2 + x(9)^2)^(1/2) - 0.41*x(7)*x(8)*(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + 0.207*x(7)*x(12)*(x(7)^2 + x(9)^2)^(1/2))*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/((x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2)),                                                                                                                                                                                                                                                                                                                                                          0.17077*x(8)*(0.118*u(1) + 0.136*u(3) - 0.41*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) + (0.1989*x(10))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + (0.207*x(12))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) - (0.30202*(0.41*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + 0.1989*x(8)*x(10) + 0.207*x(8)*x(12))*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/(x(7)^2 + x(8)^2 + x(9)^2)^(3/2),                                                                                                                                                                                                                                      x(10) + 0.17077*x(9)*(0.118*u(1) + 0.136*u(3) - 0.41*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) + (0.1989*x(10))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + (0.207*x(12))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) - (0.30202*(0.1989*x(9)*x(10)*(x(7)^2 + x(9)^2)^(1/2) - 0.41*x(8)*x(9)*(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + 0.207*x(9)*x(12)*(x(7)^2 + x(9)^2)^(1/2))*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/((x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2)),         x(9) + (0.060072*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2),                                                                                                  0,        (0.062519*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) - 1.0*x(7);
            0, 0, 0,                                                                                                                 -9.81*cos(x(5))*sin(x(4)),                                                            -9.81*cos(x(4))*sin(x(5)),                                                                                                                                                                  0,                                                                                                                                                                                                                                                                                                                                                                                                                                     x(11) + 0.30202*((1.5926*x(7)*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) + (4.451*x(9))/(x(7)^2*(x(9)^2/x(7)^2 + 1.0)))*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2) - 0.17077*x(7)*(4.451*atan(x(9)/x(7)) + (1.5926*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + 0.255),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (0.13599*x(8)*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) - 0.17077*x(8)*(4.451*atan(x(9)/x(7)) + (1.5926*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + 0.255) - 1.0*x(10),                                                                                                                                                                                                                                                                                                                                                                                                                                                    - 0.30202*(4.451/(x(7)*(x(9)^2/x(7)^2 + 1.0)) - (1.5926*x(9)*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(3/2))*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2) - 0.17077*x(9)*(4.451*atan(x(9)/x(7)) + (1.5926*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) + 0.255),                                                                                                     -1.0*x(8), x(7) - (0.481*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2),                                                                                                                0;
            0, 0, 0,                                                                                                                                         0,                                                                                    0,                                                                                                                                                                  0, -(1.0*(0.1081*x(7)*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2))*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) - 0.05405*x(7)*x(8)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) - 0.55633*x(7)^3*x(10)*(x(7)^2 + x(9)^2)^(1/2) - 0.55633*x(7)*x(8)^2*x(10)*(x(7)^2 + x(9)^2)^(1/2) - 0.55633*x(7)*x(9)^2*x(10)*(x(7)^2 + x(9)^2)^(1/2) + 1.1127*x(7)*x(10)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2) + 0.0087394*x(7)*x(12)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2) + 0.43666*u(1)*x(7)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) + 0.011098*u(3)*x(7)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2)))/((x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2)), 0.090667*x(8)*(0.0234*u(1) - 0.1224*u(3) + 0.1854*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) - (0.19278*x(12))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) - 1.7793*x(8)*(0.2466*u(1) + 0.0702*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) + (0.62532*x(10))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) - (3.1469*(0.0702*x(7)^2 + 0.0702*x(9)^2 - (0.62532*x(8)*x(10)*(x(7)^2 + x(9)^2)^(1/2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2))*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/((x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)) + (0.16035*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2)*(0.1854*x(7)^2 + 0.1854*x(9)^2 + (0.19278*x(8)*x(12)*(x(7)^2 + x(9)^2)^(1/2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)))/((x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)), -(1.0*(0.1081*x(9)*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2))*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) - 0.05405*x(8)*x(9)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) - 0.55633*x(9)^3*x(10)*(x(7)^2 + x(9)^2)^(1/2) - 0.55633*x(7)^2*x(9)*x(10)*(x(7)^2 + x(9)^2)^(1/2) - 0.55633*x(8)^2*x(9)*x(10)*(x(7)^2 + x(9)^2)^(1/2) + 1.1127*x(9)*x(10)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2) + 0.0087394*x(9)*x(12)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2) + 0.43666*u(1)*x(9)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) + 0.011098*u(3)*x(9)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2)))/((x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2)), 0.083863*x(11) - (1.9678*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2),                                                                     0.083863*x(10) - 0.64581*x(12), - 0.64581*x(11) - (0.030912*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2);
            0, 0, 0,                                                                                                                                         0,                                                                                    0,                                                                                                                                                                  0,                                                                                                                                                                                                                                                                                                                                                                                                                       3.7453*((0.45222*x(7)*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) + (0.11963*x(9))/(x(7)^2*(x(9)^2/x(7)^2 + 1.0)))*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2) - 2.1177*x(7)*(0.11963*atan(x(9)/x(7)) + 0.10541*u(2) + (0.45222*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) - 0.002032),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   (0.47884*x(8)*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) - 2.1177*x(8)*(0.11963*atan(x(9)/x(7)) + 0.10541*u(2) + (0.45222*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) - 0.002032),                                                                                                                                                                                                                                                                                                                                                                                                                              - 2.1177*x(9)*(0.11963*atan(x(9)/x(7)) + 0.10541*u(2) + (0.45222*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2) - 0.002032) - 3.7453*(0.11963/(x(7)*(x(9)^2/x(7)^2 + 1.0)) - (0.45222*x(9)*x(11))/(x(7)^2 + x(8)^2 + x(9)^2)^(3/2))*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2),                                                                                 0.56929*x(12) - 0.17978*x(10),      -(1.6937*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2),                                                                                    0.56929*x(10) + 0.17978*x(12);
            0, 0, 0,                                                                                                                                         0,                                                                                    0,                                                                                                                                                                  0,   (0.028348*x(7)^3*x(10)*(x(7)^2 + x(9)^2)^(1/2) - 0.10853*x(7)*x(8)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) + 0.21706*x(7)*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2))*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) + 0.028348*x(7)*x(8)^2*x(10)*(x(7)^2 + x(9)^2)^(1/2) + 0.028348*x(7)*x(9)^2*x(10)*(x(7)^2 + x(9)^2)^(1/2) - 0.056696*x(7)*x(10)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2) - 0.11616*x(7)*x(12)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2) + 0.0058412*u(1)*x(7)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) - 0.14751*u(3)*x(7)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2))/((x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2)), 1.2051*x(8)*(0.0234*u(1) - 0.1224*u(3) + 0.1854*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) - (0.19278*x(12))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) - 0.090667*x(8)*(0.2466*u(1) + 0.0702*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) + (0.62532*x(10))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)) - (0.16035*(0.0702*x(7)^2 + 0.0702*x(9)^2 - (0.62532*x(8)*x(10)*(x(7)^2 + x(9)^2)^(1/2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2))*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/((x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)) + (2.1313*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2)*(0.1854*x(7)^2 + 0.1854*x(9)^2 + (0.19278*x(8)*x(12)*(x(7)^2 + x(9)^2)^(1/2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)))/((x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)),   (0.028348*x(9)^3*x(10)*(x(7)^2 + x(9)^2)^(1/2) - 0.10853*x(8)*x(9)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) + 0.21706*x(9)*asin(x(8)/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2))*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) + 0.028348*x(7)^2*x(9)*x(10)*(x(7)^2 + x(9)^2)^(1/2) + 0.028348*x(8)^2*x(9)*x(10)*(x(7)^2 + x(9)^2)^(1/2) - 0.056696*x(9)*x(10)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2) - 0.11616*x(9)*x(12)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2) + 0.0058412*u(1)*x(9)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2) - 0.14751*u(3)*x(9)*(x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2))/((x(7)^2 + x(9)^2)^(1/2)*(x(7)^2 + x(8)^2 + x(9)^2)^(3/2)), 0.11468*x(11) - (0.10027*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2),                                                                     0.11468*x(10) - 0.083863*x(12), - 0.083863*x(11) - (0.41087*(0.28272*x(7)^2 + 0.28272*x(8)^2 + 0.28272*x(9)^2))/(x(7)^2 + x(8)^2 + x(9)^2)^(1/2)];
 
 hh = @(x,u) [x(1);
             x(2);
             x(3);
             x(4);
             x(5);
             x(6);
             x(7);
             x(8); 
             x(9);
             x(10);
             x(11);
             x(12)]; 
 
HH = @(x) eye(12);

%Correction term for EKP
global XdEq YdEq
vEq=[VEq; 0; 0;];
phieq=0;
psieq=0;
thetaeq=0;
RIBEq=expm(psieq*hat(e3))*expm(thetaeq*hat(e2))*expm(phieq*hat(e1));
XDotEq=RIBEq*vEq;
XdEq=XDotEq(1);
YdEq=XDotEq(2);

%% Loop for 10 steps to generate data
%To silmulate accurately, use high precision (small Ts) timestep for
%ode45()
for iter = 1:10
tf=30; %Final time, sec
Ts=.1; %Sampling time, sec
tvec=[0:Ts:tf]'; %High precision time vector, sec

in_del = 1; %Delay between command and system
out_del = 1; %Delays between system and groundstation
in_delDT = in_del/Ts; %Delay between command and system in DT
out_delDT = out_del/Ts; %Delays between system and groundstation in DT

%% Maneuver 
Maneuver='doublet';

if strcmp('none',Maneuver)
    %No maneuver
    tmaneuver=tvec; 
    onesec_steps=1/Ts;
    de_vec=deEq*ones(length(tmaneuver),1);

elseif strcmp('doublet',Maneuver)
    %Doublet start time (in sec), amplitude (in rad), and duration (in sec)
    tstart = 5; doubletAmp = 2*pi/180; duration = 2; tmaneuver=tvec; 
    for n=1:length(tvec)
        if tvec(n) >= tstart && tvec(n) < tstart+duration 
            de_vec(n) = deEq + doubletAmp; %rad
        elseif tvec(n) >= tstart+duration && tvec(n) < tstart+2*duration 
            de_vec(n) = deEq - doubletAmp; %rad
        else
            de_vec(n) = deEq;
        end
    end
    de_vec_del = addDelay(tvec, de_vec, in_del, deEq);
end

%% ODE solver 
[~,xNLund]=ode45(@(t,x) FixedWingEOM(t,x,tmaneuver,de_vec, Ts),tvec,IC);
[~,xLund]=ode45(@(t,x) FixedWingEOMLinear(t,x,sysCT.A,sysCT.B,tmaneuver,de_vec, Ts),tvec,IC);
[tNL,xNL]=ode45(@(t,x) FixedWingEOM(t,x,tmaneuver,de_vec_del, Ts),tvec,IC);
[tL,xL]=ode45(@(t,x) FixedWingEOMLinear(t,x,sysCT.A,sysCT.B,tmaneuver,de_vec_del, Ts),tvec,IC);

yNLund = Cfull*xNLund'; yLund = Cfull*xLund'; %Convert states to output
yNL = Cfull*xNL'; yL = Cfull*xL'; %Convert states to output

%Add delay in the output, Initial output: C*IC
yNL_del = addDelay(tvec, yNL, out_del, Cfull*IC);
yL_del = addDelay(tvec, yL, out_del, Cfull*IC);

%% Noise
%Add Gaussian white noise in the measurement with zero mean and some
%variance. The covariances are assumed to be zero.
NF = 10; %factor to control noise values in all the states 
x_noise_std = NF*.01; y_noise_std = NF*.01; z_noise_std = NF*.01; 
phi_noise_std = NF*.01; theta_noise_std = NF*.01; psi_noise_std = NF*.01; 
u_noise_std = NF*.1; v_noise_std = NF*.1; w_noise_std = NF*.1; 
p_noise_std = NF*.01; q_noise_std = NF*.01; r_noise_std = NF*.01;

%Create the noise vectors with the given variances and zero-mean
numb = length(tvec) + out_delDT + in_delDT;
x_noise = x_noise_std * randn(1, numb); 
y_noise = y_noise_std * randn(1, numb);
z_noise = z_noise_std * randn(1, numb); 
phi_noise = phi_noise_std * randn(1, numb); 
theta_noise = theta_noise_std * randn(1, numb); 
psi_noise = psi_noise_std * randn(1, numb); 
u_noise = u_noise_std * randn(1, numb); 
v_noise = v_noise_std * randn(1, numb); 
w_noise = w_noise_std * randn(1, numb); 
p_noise = p_noise_std * randn(1, numb);
q_noise = q_noise_std * randn(1, numb); 
r_noise = r_noise_std * randn(1, numb);

%This vector will be added to the linear and nonlinear trajectories
noise_vec = [x_noise; y_noise; z_noise; phi_noise; theta_noise; psi_noise;
    u_noise; v_noise; w_noise; p_noise; q_noise; r_noise];

%Process and measurement noise covariances
W = 0.01*eye(12); 
V = NF*diag([x_noise_std^2; y_noise_std^2; z_noise_std^2; ...
    phi_noise_std^2; theta_noise_std^2; psi_noise_std^2; ...
    u_noise_std^2; v_noise_std^2; w_noise_std^2; p_noise_std^2; ...
    q_noise_std^2; r_noise_std^2]);

%Add noise to the actual states
actual_output_L = yL + noise_vec(:, out_delDT + 1 : end - in_delDT);
actual_output_NL = yNL + noise_vec(:, out_delDT + 1 : end - in_delDT);

%Add noise to the delayed states
del_actual_output_L = yL_del + noise_vec(:, out_delDT+ in_delDT+1:end);
del_actual_output_NL = yNL_del + noise_vec(:, out_delDT+ in_delDT+1:end);

%Create the DT system
sysDT = c2d(sysCT, Ts);

%Create the 3x1 input vector
Input_undelayed = [zeros(size(de_vec)); de_vec; zeros(size(de_vec))];
%Input_undelayed is the undelayed input vector which is sent to the
%predictor. The predictor internally acts upon the delayed and the
%undelayed inputs, so we don't need to send the delayed input separately.
%However, the delayed input was used in the ODE45 to get the UAV motion

t_vector = tvec;

%Initial condition at t = in_del. Because the states are at this time step
ICdel = del_actual_output_NL(:, 1);

%%Predictor
[Time_pred_SP, YSP] = SmithPredictor(sysDT, t_vector, del_actual_output_NL, Input_undelayed, VEq, thetaEq, deEq, ICdel, in_delDT, out_delDT, e1, e2, e3, Ts);
[Time_pred_KP, YKP] = KalmanPredictor(sysDT, t_vector, del_actual_output_NL, Input_undelayed, VEq, thetaEq, deEq, W, V, ICdel, in_delDT, out_delDT, e1, e2, e3, Ts);
[TEKP, YEKP] = EKP(tvec, del_actual_output_NL, Input_undelayed, ff, FF, hh, HH, W, V, ICdel, in_delDT, out_delDT, Ts);

%%
%Create a struct to save the parameters
data.Ts = Ts; %Save the sampling time
data.d1 = in_del; %Save the input delay
data.d2 = out_del; %Save the output delay
data.undelayed_measurement = yNLund;
data.total_time = tvec;
data.SP_time = Time_pred_SP;
data.SP_output = YSP;
data.KP_time = Time_pred_KP;
data.KP_output = YKP;
data.EKP_time = TEKP;
data.EKP_output = YEKP;
data.W = W; %Save the Process noise covariance
data.V = V; %Save the measurement noise covariance
data.noise_factor = NF; %Save the noise factor multiplying "V"
data.doublet_amplitude = doubletAmp*180/pi; %Save the pitch doublet amplitude

%% Save data

iter_str = int2str(iter);

filename = 'data_';

filename = strcat(filename, iter_str)
save(filename, 'data');
end